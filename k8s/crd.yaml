apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: webhookhandlers.webhooks.example.com
spec:
  group: webhooks.example.com
  names:
    kind: WebhookHandler
    plural: webhookhandlers
    singular: webhookhandler
    shortNames:
    - wh
  scope: Namespaced
  versions:
  - name: v1
    served: true
    storage: true
    schema:
      openAPIV3Schema:
        type: object
        properties:
          spec:
            type: object
            required:
            - topic
            properties:
              topic:
                type: string
                description: Default Kafka topic name where webhook data will be sent
              signatureKey:
                type: string
                description: Optional HMAC secret key for webhook signature validation
              filters:
                type: array
                description: Optional filters to discard events before sending to Kafka
                items:
                  type: object
                  required:
                  - path
                  - operator
                  - value
                  properties:
                    path:
                      type: string
                      description: JSONPath expression to extract value (e.g., "$.payload.account_id")
                    operator:
                      type: string
                      description: Filter operator
                      enum:
                      - equals
                      - not_equals
                      - in
                      - not_in
                      - contains
                      - not_contains
                    value:
                      x-kubernetes-preserve-unknown-fields: true
                      description: Value or array of values to compare against
              routes:
                type: array
                description: Optional routing rules to send events to different topics
                items:
                  type: object
                  required:
                  - path
                  - mapping
                  properties:
                    path:
                      type: string
                      description: JSONPath expression for routing (e.g., "$.payload.account_id")
                    mapping:
                      type: array
                      items:
                        type: object
                        required:
                        - value
                        - topic
                        properties:
                          value:
                            type: string
                            description: Value to match for routing
                          topic:
                            type: string
                            description: Topic to route to when matched
          status:
            type: object
            properties:
              handlerUrl:
                type: string
                description: Full URL of the webhook handler endpoint
              ready:
                type: boolean
                description: Whether the handler is ready to receive webhooks
    subresources:
      status: {}
    additionalPrinterColumns:
    - name: Topic
      type: string
      description: Kafka topic
      jsonPath: .spec.topic
    - name: URL
      type: string
      description: Webhook URL
      jsonPath: .status.handlerUrl
    - name: Ready
      type: boolean
      description: Ready status
      jsonPath: .status.ready
    - name: Age
      type: date
      jsonPath: .metadata.creationTimestamp